<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chicago Crime Map with Line and Doughnut Charts</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* === Base Layout === */
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f9f9f9;
    }

    #dashboard {
      display: flex;
      height: 100vh;
      width: 100vw;
      gap: 20px;
      padding: 20px;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* === Shared Card Styles === */
    .card {
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 16px;
      margin-bottom: 0px;
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card.hidden {
      display: none;
      opacity: 0;
    }

    .card h3 {
      margin-top: 0;
      font-size: 16px;
      color: #333;
    }

    /* === Map Panel === */
    #map-panel {
      flex: 6;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #map {
      flex: 1;
      background: #fff;
      position: relative;
      height: 100%;
    }

    #map path {
      fill: #dddddd;
      stroke: #999;
      stroke-width: 0.5;
    }

    .selected {
      fill: #bdbcbc !important;
      stroke: #333 !important;
      stroke-width: 1.5;
    }

    .dimmed {
      opacity: 0.6;
    }

    /* === Doughnut Panel === */
    #doughnut-panel {
      flex: 4;
      height: 100%;
      max-height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-sizing: border-box;
      width: auto;
      gap: 12px;
    }

    /* === Doughnut Chart === */
    #doughnut-chart {
      width: 100%;
      height: auto;
      aspect-ratio: 1 / 1;
      max-width: 300px;
      margin: 0 auto;
      display: block;
    }

    #doughnut {
      width: 100%;
    }

    #doughnut h2 {
      font-size: 16px;
      margin-bottom: 10px;
    }

    /* === Legend === */
    #legend {
      margin-top: 15px;
      font-size: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .legend-swatch {
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border-radius: 2px;
    }

    /* === Indicators Panel === */
    #indicators-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 8px;
      box-sizing: border-box;
    }

    #indicators {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: 100%;
      padding: 8px 12px;
      box-sizing: border-box;
    }

    #indicators::-webkit-scrollbar {
      width: 6px;
    }

    .indicator-row {
      width: 100%;
      margin-bottom: 8px;
      padding: 8px 0;
      font-family: sans-serif;
      box-sizing: border-box;
      border-bottom: 1px solid #e0e0e0;
    }

    .indicator-row:nth-child(even) {
      background-color: #f9f9f9;
    }

    .indicator-label {
      font-size: 12px;
      margin-bottom: 3px;
      color: #333;
    }

    .indicator-bar-container {
      position: relative;
      height: 12px;
      background: #eee;
      border-radius: 3px;
      width: 100%;
      overflow: hidden;
      box-sizing: border-box;
    }

    .indicator-bar-fill {
      background: #4c6ef5;
      height: 100%;
      border-radius: 3px;
      max-width: 100%;
      transition: width 0.4s ease;
    }

    .indicator-value {
      position: absolute;
      right: 5px;
      top: -1px;
      font-size: 10px;
      color: #333;
      white-space: nowrap;
      background: white;
    }

    /* === Tooltip Chart === */
    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 12px;
      color: #000;
      pointer-events: none;
      opacity: 0;
      width: 300px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 10;
    }

    .tooltip svg {
      width: 280px;
      height: 120px;
      background: #ffffff;
      margin-top: 5px;
    }

    #tooltip-chart path {
      fill: lightblue;
      stroke: steelblue;
      stroke-width: 1.0;
    }

    /* === Crime Spikes === */
    polygon.spike {
      fill: #ff5252;
      opacity: 0.5;
      pointer-events: none;
    }

    /* === SVG General === */
    svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    /* === Utility === */
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div id="dashboard">
  <div id="map-panel" class="card">
    <h3>Community Map</h3>
    <div id="map">
      <svg></svg>
      <div class="tooltip" id="tooltip">
        <div id="tooltip-header"></div>
        <svg id="tooltip-chart"></svg>
      </div>
    </div>
  </div>

  <div id="doughnut-panel">
    <div id="doughnut" class="card hidden">
      <h3 id="doughnut-title">Crime by Category</h3>
      <svg id="doughnut-chart" width="160" height="160"></svg>
      <div id="legend"></div>
    </div>

    <div id="indicators-card" class="card hidden">
      <h3>Socio-economic Indicators</h3>
      <div id="indicators"></div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const svg = d3.select("svg");
  const tooltip = d3.select("#tooltip");
  const tooltipHeader = d3.select("#tooltip-header");
  const chartSvg = d3.select("#tooltip-chart");
  const doughnutSvg = d3.select("#doughnut-chart");
  const doughnutTitle = d3.select("#doughnut-title");

  function getMapDimensions() {
    const mapContainer = document.querySelector("#map");
    const width = mapContainer.clientWidth || 600;
    const height = mapContainer.clientHeight || 600;
    return { width, height };
  }

  // Get dimensions dynamically after DOM is ready
  const { width, height } = getMapDimensions();

  const spikeWidth = 10;

  let crimeByCategory = [];
  let indicatorScales = [];

  Promise.all([
    d3.json("data/chicago.geojson"),
    d3.csv("data/crime_rate_by_crime_type.csv", d3.autoType),
    d3.csv("data/crime_rate_by_crime_group.csv", d3.autoType),
    d3.csv("data/top_features_per_CA_sorted.csv", d3.autoType)
  ]).then(([geojson, crimes, crimeGroup, features]) => {
    topFeatures = features;
    const indicators = features.columns.filter(c => !["CA", "GEOG", "Crime_Rate"].includes(c));
    indicators.forEach(key => {
      const values = features.map(d => +d[key]).filter(v => !isNaN(v));
      indicatorScales[key] = d3.scaleLinear().domain(d3.extent(values)).range([0, 1]);
    });

    const avgCrimeByCA = d3.rollup(crimes, v => d3.mean(v, d => d.Crime_Rate), d => d.CA);
    crimeByCategory = d3.rollups(crimeGroup, v => d3.sum(v, d => d.Crime_Count), d => d.CA, d => d.Crime_Category);

    const projection = d3.geoMercator();
    const path = d3.geoPath().projection(projection);
    projection.fitSize([width, height], geojson);

    const mapGroup = svg.append("g")
    .attr(
      "transform",
      `translate(${width / 2}, ${height / 2}) translate(-${width / 2}, -${height / 2})`
    );

    let activeCA = null;

    mapGroup.selectAll("path")
      .data(geojson.features)
      .join("path")
      .attr("class", "community")
      .attr("d", path)
      .on("mouseover", (event, d) => {
        const caId = +d.properties.area_num_1;
        drawLineChart(caId, d.properties.community);
        tooltip.style("opacity", 1);
      })
      .on("mousemove", (event) => {
        tooltip.style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 20) + "px");
      })
      .on("mouseout", () => tooltip.style("opacity", 0))
      .on("click", (event, d) => {
        const caId = +d.properties.area_num_1;
        const community = d.properties.community;
        if (activeCA === caId) {
          activeCA = null;
          svg.selectAll("path").classed("selected", false).classed("dimmed", false);
          d3.select("#doughnut").classed("hidden", true);
          d3.select("#indicators-card").classed("hidden", true);
        } else {
          activeCA = caId;
          svg.selectAll("path").classed("selected", dd => dd === d).classed("dimmed", dd => dd !== d);
          drawRightChart(caId, community);
        }
      });

    const maxCrime = d3.max(Array.from(avgCrimeByCA.values()));
    const spikeScale = d3.scaleLinear().domain([0, maxCrime]).range([0, 100]);

    mapGroup.append("g")
      .selectAll("polygon")
      .data(geojson.features)
      .join("polygon")
      .attr("class", "spike")
      .attr("points", d => {
        const [x, y] = path.centroid(d);
        const caId = +d.properties.area_num_1;
        const rate = avgCrimeByCA.get(caId);
        const height = rate ? spikeScale(rate) : 0;
        return [[x, y - height], [x - spikeWidth / 2, y], [x + spikeWidth / 2, y]].map(p => p.join(",")).join(" ");
      });

    // Tooltip chart (grouped by year)
    function drawLineChart(caId, communityName) {
      const yearlyData = Array.from(
        d3.group(
          crimes.filter(d => d.CA === caId),
          d => d.Year
        ),
        ([year, values]) => ({
          date: new Date(+year, 0, 1),
          rate: d3.mean(values, d => d.Crime_Rate)
        })
      ).sort((a, b) => a.date - b.date);

      const avgRate = d3.mean(yearlyData, d => d.rate);
      tooltipHeader.html(`
        <strong>${communityName}</strong><br>
        Avg. Crime Rate: ${avgRate.toFixed(2)}
      `);

      chartSvg.selectAll("*").remove();

      const margin = { top: 10, right: 10, bottom: 25, left: 35 };
      const width = 280, height = 120;
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;

      const x = d3.scaleTime()
        .domain(d3.extent(yearlyData, d => d.date))
        .range([0, innerWidth]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(yearlyData, d => d.rate)])
        .nice()
        .range([innerHeight, 0]);

      const g = chartSvg
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const area = d3.area()
        .defined(d => !isNaN(d.rate))
        .x(d => x(d.date))
        .y0(innerHeight)
        .y1(d => y(d.rate));

      // g.append("rect")
      //   .attr("width", innerWidth)
      //   .attr("height", innerHeight)
      //   .attr("fill", "#f0f0f0");

      g.append("path")
        .datum(yearlyData)
        .attr("fill", "lightsteelblue")
        .attr("d", area);

      g.append("path")
        .datum(yearlyData)
        .attr("fill", "none")
        .attr("stroke", "#4682b4")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
          .defined(d => !isNaN(d.rate))
          .x(d => x(d.date))
          .y(d => y(d.rate)));

      g.append("g")
        .call(d3.axisLeft(y).ticks(3).tickSize(-innerWidth).tickPadding(4))
        .call(g => g.select(".domain").remove());

      g.append("g")
        .attr("transform", `translate(0,${innerHeight})`)
        .call(d3.axisBottom(x)
          .ticks(d3.timeYear.every(2))
          .tickFormat(d3.timeFormat("%Y"))
          .tickPadding(4))
        .call(g => g.select(".domain").remove());
    }

    function drawRightChart(caId, community) {
      renderDoughnutChart(caId, community);
      renderIndicators(caId);
    }

    function renderDoughnutChart(caId, community) {
      d3.select("#doughnut").classed("hidden", false);
      d3.select("#indicators-card").classed("hidden", false);
      doughnutTitle.text(`${community} â€“ Crime by Category`);

      const caData = crimeByCategory.find(d => +d[0] === caId);
      if (!caData) return;

      const data = caData[1].map(([category, count]) => ({ category, count }));
      data.sort((a, b) => b.count - a.count);
      const total = d3.sum(data, d => d.count);

      const pastelNice = [
        "#4c6ef5", "#a5d8ff", "#ffd43b", "#ff6b6b",
        "#d0bfff", "#63e6be", "#ffa8a8", "#ffcbf2",
        "#a3c4f3", "#c3f584", "#ffc09f", "#f6b8b8"
      ];

      const color = d3.scaleOrdinal()
        .domain(data.map(d => d.category))
        .range(pastelNice);

      doughnutSvg.selectAll("*").remove();
      const radius = 160;
      const g = doughnutSvg.append("g")
        .attr("transform", `translate(${radius},${radius})`);

      const arc = d3.arc()
        .innerRadius(radius * 0.5)
        .outerRadius(radius - 10);

      const pie = d3.pie().value(d => d.count);

      g.selectAll("path")
        .data(pie(data))
        .join("path")
        .attr("fill", d => color(d.data.category))
        .attr("d", arc)
        .append("title")
        .text(d => `${d.data.category}: ${d.data.count}`);

      // Render legend
      const legend = d3.select("#legend");
      legend.selectAll("*").remove();

      legend.selectAll(".legend-item")
        .data(data)
        .enter()
        .append("div")
        .attr("class", "legend-item")
        .html(d => {
          const percent = ((d.count / total) * 100).toFixed(1);
          return `
            <div class="legend-swatch" style="background:${color(d.category)}"></div>
            ${d.category} (${d.count} | ${percent}%)
          `;
        });
    }

    function renderIndicators(caId) {
      const indicatorsDiv = d3.select("#indicators");
      indicatorsDiv.selectAll("*").remove();

      const indicatorRow = topFeatures.find(d => +d.CA === caId);
      if (!indicatorRow) return;

      const indicators = Object.entries(indicatorRow)
        .filter(([key]) => !["CA", "GEOG", "Crime_Rate"].includes(key))
        .map(([key, value]) => ({
          label: key.replace(/_/g, " "),
          rawKey: key,
          value: +value
        }));

      indicatorsDiv
        .selectAll(".indicator-row")
        .data(indicators)
        .enter()
        .append("div")
        .attr("class", "indicator-row")
        .html(d => `
          <div class="indicator-label">${d.label}</div>
          <div class="indicator-bar-container">
            <div 
              class="indicator-bar-fill" 
              style="width: ${(indicatorScales[d.rawKey](d.value) * 100).toFixed(2)}%;"
            ></div>
            <div class="indicator-value">${d.value.toFixed(2)}</div>
          </div>
        `);
    }
  });
});
// document.body.addEventListener("click", function (e) {
//   // If the click was not on a map area
//   if (!e.target.closest("path.community")) {
//     svg.selectAll("path")
//       .classed("selected", false)
//       .classed("dimmed", false);
//        // Hide data views
//        d3.select("#doughnut").classed("hidden", true);
//        d3.select("#indicators-card").classed("hidden", true);
//   }
// });
</script>

</body>
</html>
